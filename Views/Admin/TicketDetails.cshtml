@using Microsoft.AspNetCore.Identity
@using praca_dyplomowa_zesp.Models.Interactions
@using praca_dyplomowa_zesp.Models.Modules.Users
@using praca_dyplomowa_zesp.Models
@inject UserManager<User> UserManager
@model Ticket

@{
    Layout = "_Layout";
    ViewData["Title"] = $"Obsługa zgłoszenia #{Model.Id}";

    var currentAdminId = UserManager.GetUserId(User);

    async Task<string> GetUserRoleColor(User user)
    {
        if (user == null) return "var(--neon-cyan)";
        if (await UserManager.IsInRoleAsync(user, "Admin")) return "var(--neon-red)";
        if (await UserManager.IsInRoleAsync(user, "Moderator")) return "var(--neon-green)";
        return "var(--neon-cyan)";
    }

    string authorColor = await GetUserRoleColor(Model.User);
}

<div id="toast-container" class="position-fixed top-50 start-50 translate-middle p-3" style="z-index: 9999; min-width: 450px;"></div>

<div class="container-fluid admin-container fade-in-up d-flex flex-column" style="margin-top: 30px; height: calc(100vh - 80px);">

    <div class="d-flex justify-content-between align-items-center mb-3 flex-shrink-0">
        <h2 class="admin-title text-start m-0" style="font-size: 1.8rem;">Zgłoszenie #@Model.Id</h2>
        <a asp-controller="Admin" asp-action="Index" class="btn btn-low-tier btn-sm h-100">
            <i class="bi bi-arrow-return-left me-2"></i> POWRÓT
        </a>
    </div>

    <div class="ticket-info-bar d-flex flex-wrap align-items-center mb-3 flex-shrink-0">

        <div class="d-flex align-items-center gap-3">
            <div class="flex-shrink-0">
                <img src="@Url.Action("GetAvatar", "Profile", new { id = Model.UserId })"
                     class="author-avatar"
                     style="width: 40px; height: 40px; border-color: @authorColor; box-shadow: 0 0 10px @authorColor.Replace("var", "rgba").Replace(")", ", 0.4)");">
            </div>
            <div>
                <small class="text-muted d-block" style="font-size: 0.65rem; line-height: 1;">Autor</small>
                <span class="text-white fw-bold">@(Model.User?.UserName ?? "Użytkownik")</span>
            </div>
        </div>

        <div class="info-separator d-none d-md-block"></div>

        <div class="d-flex flex-column justify-content-center">
            <small class="text-muted" style="font-size: 0.65rem; line-height: 1;">Temat</small>
            <span class="text-white text-truncate" style="max-width: 250px;">@Model.Title</span>
        </div>

        <div class="info-separator d-none d-md-block"></div>

        <div class="d-flex flex-column justify-content-center">
            <small class="text-muted" style="font-size: 0.65rem; line-height: 1;">Status</small>
            <div>
                @{
                    var statusBadge = Model.Status switch
                    {
                        TicketStatus.Oczekujące => "status-badge-light text-neon-green border-success",
                        TicketStatus.W_trakcie => "status-badge-yellow",
                        _ => "status-badge-grey"
                    };
                }
                <span class="status-badge @statusBadge ms-0" style="padding: 2px 8px; font-size: 0.7rem;">@Model.Status.ToString().ToUpper().Replace("_", " ")</span>
            </div>
        </div>

        <div class="ms-auto">
            @if (Model.Status != TicketStatus.Zamknięte)
            {
                <button type="button" class="btn btn-danger-custom btn-sm fw-bold px-3" data-bs-toggle="modal" data-bs-target="#closeTicketModal">
                    <i class="bi bi-lock-fill me-2"></i> ZAMKNIJ
                </button>
            }
            else
            {
                <div class="d-flex align-items-center text-muted border border-secondary rounded px-3 py-1 bg-black bg-opacity-25">
                    <i class="bi bi-shield-lock-fill me-2 text-danger"></i> ZAMKNIĘTE
                </div>
            }
        </div>
    </div>

    <div class="ticket-chat-wrapper d-flex flex-column flex-grow-1" style="border-color: var(--neon-purple); box-shadow: 0 0 25px rgba(189, 0, 255, 0.1); min-height: 0;">

        <div class="chat-header-bar flex-shrink-0">
            <span class="fw-bold text-white"><i class="bi bi-chat-text-fill me-2 text-neon-purple"></i>HISTORIA CZATU</span>
            <span class="text-muted" style="font-size: 0.8rem;">Wiadomości: @(Model.Messages.Count + 1)</span>
        </div>

        <div class="pinned-problem p-3 flex-shrink-0"
             style="border-bottom: 1px solid var(--neon-purple); background: rgba(0,0,0,0.2); max-height: 250px; overflow-y: auto;">
            <div class="d-flex align-items-center mb-2">
                <i class="bi bi-pin-angle-fill text-neon-purple me-2"></i>
                <h6 class="text-uppercase fw-bold mb-0 text-muted" style="font-size: 0.75rem;">Treść zgłoszenia:</h6>
            </div>
            <p class="mb-0 text-white" style="white-space: pre-wrap; font-size: 0.95rem;">@Model.Content</p>
        </div>

        <div class="chat-messages-area p-3 flex-grow-1" id="adminChatBox" style="overflow-y: auto;">

            @if (!Model.Messages.Any())
            {
                <div class="text-center text-muted mt-5">
                    <small>Brak nowych odpowiedzi w tym zgłoszeniu.</small>
                </div>
            }

            @foreach (var msg in Model.Messages.OrderBy(m => m.CreatedAt))
            {
                bool isStaff = msg.IsStaffReply;
                bool isMe = msg.UserId.ToString() == currentAdminId;
                string msgColor = await GetUserRoleColor(msg.User);

                string flexClass = isStaff ? "justify-content-start" : "justify-content-end";

                <div class="d-flex @flexClass mb-3 w-100">

                    @if (isStaff)
                    {
                        <div class="me-2 flex-shrink-0">
                            <img src="@Url.Action("GetAvatar", "Profile", new { id = msg.UserId })"
                                 class="rounded-circle"
                                 style="border: 2px solid @msgColor; width: 45px; height: 45px; object-fit: cover;">
                        </div>
                    }

                    <div class="msg-bubble text-start position-relative"
                         style="border: 1px solid @(msgColor) !important; max-width: 75%; padding: 10px 15px; border-radius: 12px; background: rgba(0,0,0,0.3);">

                        <div class="msg-meta mb-1" style="color: @msgColor;">
                            @if (isStaff)
                            {
                                <span>SUPPORT @(isMe ? "(Ty)" : $"({msg.User?.UserName})")</span>
                                <span class="text-muted ms-2 fw-normal" style="font-size: 0.65rem;">@msg.CreatedAt.ToString("dd.MM HH:mm")</span>
                            }
                            else
                            {
                                <span>@(msg.User?.UserName ?? "Użytkownik")</span>
                                <span class="text-muted ms-2 fw-normal" style="font-size: 0.65rem;">@msg.CreatedAt.ToString("dd.MM HH:mm")</span>
                            }
                        </div>

                        <div class="msg-content" style="white-space: pre-wrap; word-break: break-word;">@msg.Message</div>

                        @if (msg.Attachments?.Any() == true)
                        {
                            <div class="d-flex flex-wrap gap-2 mt-2 pt-2 border-top border-secondary @(isStaff ? "justify-content-start" : "justify-content-end")"
                                 style="border-color: rgba(255,255,255,0.1) !important;">
                                @foreach (var att in msg.Attachments)
                                {
                                    <img src="data:@att.ContentType;base64,@Convert.ToBase64String(att.FileContent)"
                                         class="rounded border border-secondary"
                                         style="width: 80px; height: 80px; object-fit: cover; cursor: pointer;"
                                         data-bs-toggle="modal" data-bs-target="#img-@att.Id" />
                                }
                            </div>
                        }
                    </div>

                    @if (!isStaff)
                    {
                        <div class="ms-2 flex-shrink-0">
                            <img src="@Url.Action("GetAvatar", "Profile", new { id = msg.UserId })"
                                 class="rounded-circle"
                                 style="border: 2px solid @msgColor; width: 45px; height: 45px; object-fit: cover;">
                        </div>
                    }
                </div>
            }
        </div>

        @if (Model.Status != TicketStatus.Zamknięte)
        {
            <div class="chat-footer flex-shrink-0">
                <form asp-action="AdminReply" method="post" enctype="multipart/form-data" id="replyForm">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <div id="adminPreviews" class="d-flex flex-wrap mb-2"></div>
                    <input type="file" name="attachments" id="adminAttachmentInput" class="d-none" multiple accept="image/*" />

                    <div class="d-flex align-items-center">
                        <button type="button" class="btn-attachment me-2" onclick="document.getElementById('adminAttachmentInput').click()" title="Dodaj plik">
                            <i class="bi bi-paperclip"></i>
                        </button>
                        <div class="chat-input-merged flex-grow-1">
                            <div class="form-floating flex-grow-1">
                                <input type="text"
                                       name="message"
                                       id="adminMessageInput"
                                       class="form-control"
                                       placeholder="Odpowiedź"
                                       style="height: 55px; background: transparent !important; color: white !important; border: 1px solid transparent !important; box-shadow: none !important;"
                                       autocomplete="off" />
                                <label for="adminMessageInput">Wpisz odpowiedź do użytkownika...</label>
                            </div>
                            <button type="submit" class="btn-send-integrated">
                                WYŚLIJ <i class="bi bi-send-fill ms-2"></i>
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        }
        else
        {
            <div class="chat-footer text-center flex-shrink-0">
                <div class="p-3 text-muted"><i class="bi bi-lock-fill me-2"></i> Możliwość odpowiadania została zablokowana.</div>
            </div>
        }
    </div>
</div>

<div class="modal fade" id="closeTicketModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content text-center" style="background-color: #1a1a1a; border: 1px solid var(--neon-red); box-shadow: 0 0 20px rgba(255, 0, 0, 0.2);">
            <div class="modal-header border-0 justify-content-center pb-0">
                <h5 class="modal-title text-white fw-bold"><i class="bi bi-exclamation-triangle-fill text-danger me-2"></i>Zamknij zgłoszenie</h5>
            </div>
            <div class="modal-body text-white py-4">
                <p class="mb-0">Czy na pewno chcesz zamknąć to zgłoszenie?<br>Ta operacja zablokuje możliwość dodawania nowych odpowiedzi.</p>
            </div>
            <div class="modal-footer border-0 justify-content-center gap-3 pt-0 pb-4">
                <button type="button" class="btn btn-ghost-cancel px-4" data-bs-dismiss="modal">Anuluj</button>
                <form asp-action="CloseTicket" method="post">
                    <input type="hidden" name="id" value="@Model.Id" />
                    <button type="submit" class="btn btn-danger-custom px-4 fw-bold">Potwierdź</button>
                </form>
            </div>
        </div>
    </div>
</div>

@foreach (var msg in Model.Messages.Where(m => m.Attachments != null && m.Attachments.Any()))
{
    foreach (var att in msg.Attachments)
    {
        <div class="modal fade" id="img-@att.Id" tabindex="-1">
            <div class="modal-dialog modal-dialog-centered modal-lg">
                <div class="modal-content bg-transparent border-0">
                    <div class="modal-body p-0 text-center position-relative">
                        <img src="data:@att.ContentType;base64,@Convert.ToBase64String(att.FileContent)"
                             class="img-fluid rounded border border-secondary"
                             style="max-height: 90vh;" />

                        <button type="button"
                                class="btn-close btn-close-white position-absolute top-0 end-0 m-3"
                                style="z-index: 9999; box-shadow: 0 0 10px rgba(0,0,0,0.5);"
                                data-bs-dismiss="modal"></button>
                    </div>
                </div>
            </div>
        </div>
    }
}

<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chatBox = document.getElementById('adminChatBox');
        if (chatBox) chatBox.scrollTop = chatBox.scrollHeight;
    });

    const dtAdmin = new DataTransfer();
    const adminInput = document.getElementById('adminAttachmentInput');
    const adminPreviewsDiv = document.getElementById('adminPreviews');
    const msgInput = document.getElementById('adminMessageInput');
    const replyForm = document.getElementById('replyForm');

    if(msgInput && replyForm) {
        msgInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                if(this.value.trim() !== "") {
                    replyForm.submit();
                }
            }
        });
    }

    adminInput?.addEventListener('change', function () {
        for (let i = 0; i < this.files.length; i++) {
            const file = this.files[i];
            if (file.type.startsWith('image/')) {
                dtAdmin.items.add(file);
                const reader = new FileReader();
                reader.onload = e => {
                    const div = document.createElement('div');
                    div.className = 'attachment-preview-wrapper';
                    div.innerHTML = `
                        <img src="${e.target.result}" class="attachment-preview-img">
                        <button type="button" class="btn-remove-attachment" onclick="removeAdminFile(${dtAdmin.items.length - 1})"><i class="bi bi-x"></i></button>
                    `;
                    adminPreviewsDiv.appendChild(div);
                };
                reader.readAsDataURL(file);
            }
        }
        adminInput.files = dtAdmin.files;
    });

    function removeAdminFile(index) {
        dtAdmin.items.remove(index);
        adminInput.files = dtAdmin.files;
        adminPreviewsDiv.children[index].remove();
    }
</script>